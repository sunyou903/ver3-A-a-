<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>두 파일 매칭 · MatchFlag</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#0b0c10; --panel:#101219; --card:#141820; --text:#e7eaf1; --muted:#9aa3b2; --border:#242a35; --brand:#6e6cff; --accent:#79ffe1; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.25); }
    :root.light { --bg:#f7f8fb; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e7eaf1; --brand:#4f46e5; --accent:#10b981; --shadow:0 12px 30px rgba(20,24,40,.06); }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1100px 600px at 110% -10%, color-mix(in srgb,var(--brand) 12%, transparent), transparent 60%),
        radial-gradient(1200px 800px at -10% 120%, color-mix(in srgb,var(--accent) 10%, transparent), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;
      line-height:1.6
    }
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .nav{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(10px);background:color-mix(in srgb,var(--panel) 70%, transparent);border-bottom:1px solid var(--border)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo{width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--brand),var(--accent));box-shadow:var(--shadow)}
    .toggle{width:48px;height:28px;border-radius:999px;border:1px solid var(--border);background:var(--panel);position:relative;cursor:pointer}
    .dot{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--accent));transition:transform .2s ease}
    .toggle.active .dot{transform:translateX(20px)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:linear-gradient(180deg,color-mix(in srgb,var(--panel) 96%, transparent),var(--card));border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
    @media(min-width:840px){.half{grid-column:span 6}}
    h1{font-size:clamp(22px,3vw,32px);margin:12px 0 6px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row-2{grid-template-columns:repeat(2,1fr)}}
    label{font-size:13px;color:var(--muted)}
    .input, .file {width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
    .file{padding:10px 12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid color-mix(in srgb,var(--brand) 40%, var(--border));background:linear-gradient(180deg,color-mix(in srgb,var(--brand) 12%, var(--card)),var(--card));color:var(--text);font-weight:700;cursor:pointer;transition:transform .08s ease,border-color .2s ease}
    .btn:hover{transform:translateY(-1px);border-color:var(--brand)}
    .btn.ghost{background:var(--panel);border-color:var(--border);font-weight:600}
    /* Log */
    .log{height:200px;overflow:auto;border:1px dashed color-mix(in srgb,var(--muted) 40%, var(--border));border-radius:12px;background:var(--panel);padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;white-space:pre-wrap}
    .progress{height:10px;border-radius:999px;background:color-mix(in srgb,var(--border) 60%, transparent);overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .3s ease}
    .hint{font-size:12px;color:var(--muted)}
  
    /* Drag & Drop */
    .dropzone{display:flex;align-items:center;justify-content:center;gap:8px;
      padding:18px;border:2px dashed var(--border);border-radius:12px;background:color-mix(in srgb, var(--panel) 92%, transparent);
      color:var(--muted); cursor:pointer; transition:border-color .2s ease, background .2s ease}
    .dropzone:hover{border-color:var(--brand)}
    .dropzone.dragover{border-color:var(--accent); background:color-mix(in srgb, var(--accent) 6%, var(--panel))}
    .dropzone .name{color:var(--text); font-weight:600}
    input.file{display:none}
    
</style>

    <style>
    .row-between{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
    .btn.small{padding:6px 10px;font-size:.9em}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;z-index:50}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.4)}
    .modal-panel{position:absolute;inset:5% 6%;background:var(--panel);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column}
    .modal-header,.modal-footer{padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal-footer{border-top:1px solid var(--border);border-bottom:none}
    .table-wrap{padding:12px 16px;overflow:auto;height:70vh}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px;border-bottom:1px solid var(--border)}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:var(--card)}
    .tab.active{border-color:var(--accent)}
    table{border-collapse:collapse;font-size:12px}
    table td, table th{border:1px solid var(--border);padding:4px 6px;white-space:nowrap}
    .muted{color:var(--muted)}
    </style>
    

    <style>
      .tabs{overflow:auto;white-space:nowrap}
      .tabs::-webkit-scrollbar{height:8px}
    </style>
    <style id="fix-sheet-tab-visibility">
        /* 결과 미리보기 탭 시트명 표시 보정 (matchflag.html 참조) */
        #xlSheetTabs { 
          overflow: auto; 
          white-space: normal;           /* 줄바꿈 허용 */
          padding: 8px 16px;             /* 기존과 동일한 패딩 */
          border-bottom: 1px solid var(--border);
          display: flex; 
          gap: 8px; 
          flex-wrap: wrap;
        }
        #xlSheetTabs .tab{
          padding: 6px 10px;
          border: 1px solid var(--border);
          border-radius: 10px;
          cursor: pointer;
          background: var(--card);
          color: var(--text) !important; /* 텍스트 가시성 보장 */
          font-weight: 600;
          line-height: 1.2;
        }
        #xlSheetTabs .tab.active{
          border-color: var(--accent);
          color: var(--text) !important;
        }
      </style>
      
</head>
<body>
  <header class="nav">
    <div class="nav-inner container">
      <div class="brand"><div class="logo" aria-hidden="true"></div>MatchFlag</div>
      <nav style="display:flex;gap:10px;">
        <a href="index.html" class="btn ghost" style="padding:6px 10px;font-size:14px;">두 파일 매칭</a>
        <a href="matchflag.html" class="btn ghost" style="padding:6px 10px;font-size:14px;">다시트 검증</a>
      </nav>

      <button id="themeBtn" class="toggle" aria-label="테마 전환"><span class="dot"></span></button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h1>두 파일 매칭</h1>
      <p class="muted">엑셀 A/B의 <strong>단가대비표</strong> 시트를 기준으로 항목을 매칭하고, 가격 항목을 비교합니다. (브라우저 내 처리)</p>

      <div class="grid" style="margin-top:12px;">
        <div class="card half">
          <div class="row">
            <div>
              <label for="fileA">파일 A</label>
<div class="row-between"><span>파일 A</span><button id="previewA" class="btn" type="button">미리보기</button></div>
<div id="dropA" class="dropzone" role="button" aria-label="파일 A 드래그&드롭 또는 클릭하여 선택"><span class="hint">여기로 파일을 드래그하거나 클릭해서 선택</span> <span id="nameA" class="name"></span></div>
<input id="fileA" class="file" type="file" accept=".xlsx,.xls,.xlsm,.xlsb" />
            </div>
            <div>
              <label for="sheetA">시트명 (기본: 단가대비표)</label>
              <input id="sheetA" class="input" placeholder="단가대비표" />
            </div>
          </div>
        </div>
        <div class="card half">
          <div class="row">
            <div>
              <label for="fileB">파일 B</label>
<div class="row-between"><span>파일 B</span><button id="previewB" class="btn" type="button">미리보기</button></div>
<div id="dropB" class="dropzone" role="button" aria-label="파일 B 드래그&드롭 또는 클릭하여 선택"><span class="hint">여기로 파일을 드래그하거나 클릭해서 선택</span> <span id="nameB" class="name"></span></div>
<input id="fileB" class="file" type="file" accept=".xlsx,.xls,.xlsm,.xlsb" />
            </div>
            <div>
              <label for="sheetB">시트명 (기본: 단가대비표)</label>
              <input id="sheetB" class="input" placeholder="단가대비표" />
            </div>
          </div>
        </div>
      </div>

      <div class="row row-2" style="margin-top:12px;align-items:end;">
        <div>
          <label for="threshold">유사도 임계값 (%)</label>
          <input id="threshold" class="input" type="number" min="0" max="100" step="1" value="30" />
          <div class="hint">낮을수록 느슨하게 매칭합니다. 데이터 품질이 낮으면 40–60% 권장.</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button id="run" class="btn" aria-label="매칭 실행">매칭 실행</button> <button id="resultPreview" class="btn" type="button" disabled>결과 미리보기</button>
          <button id="resultDownload" class="btn" type="button" disabled>결과 다운로드</button>
          <button id="clear" class="btn ghost" aria-label="입력 초기화">초기화</button>
        </div>
      </div>

      <div class="progress" style="margin:16px 0 8px;"><div id="bar" class="bar"></div></div>
      <div id="log" class="log" aria-live="polite">대기 중…</div>
    </section>
  </main>

  <script>
    // Theme
    const root = document.documentElement; const btn = document.getElementById('themeBtn');
    const setTheme = (m)=>{ if(m==='light') root.classList.add('light'); else root.classList.remove('light'); localStorage.setItem('mf-theme', m); btn.classList.toggle('active', m==='light'); };
    setTheme(localStorage.getItem('mf-theme') || (matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'));
    btn.addEventListener('click',()=> setTheme(root.classList.contains('light')?'dark':'light'));

    // UX helpers
    const log = document.getElementById('log'); const bar = document.getElementById('bar');
    document.getElementById('clear').addEventListener('click',()=>{ ['fileA','fileB','sheetA','sheetB'].forEach(id=>{const el=document.getElementById(id); if(el && el.type==='file') el.value=''; else if(el) el.value='';}); log.textContent='초기화됨'; bar.style.width='0%'; });
   
  </script>
  
  <script>
  // Drag & Drop helpers for index.html
  function bindDropzone(zoneId, inputId, nameId){
    const zone = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    const nameEl = document.getElementById(nameId);
    if(!zone || !input) return;
    const accept = (input.getAttribute('accept')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

    function setFile(file){
      const ok = accept.length===0 || accept.some(ext => file.name.toLowerCase().endsWith(ext));
      if(!ok){ alert('지원하지 않는 파일 형식입니다: ' + file.name); return; }
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      if(nameEl){ nameEl.textContent = file.name; }
      const lg = document.getElementById('log');
      if(lg){ lg.textContent = (lg.textContent||'') + '\n선택됨: ' + file.name; }
    }

    zone.addEventListener('click', () => input.click());
    input.addEventListener('change', () => { if(input.files && input.files[0]) setFile(input.files[0]); });
    ['dragenter','dragover'].forEach(ev => zone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); zone.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => zone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); zone.classList.remove('dragover'); }));
    zone.addEventListener('drop', (e)=>{
      const files = e.dataTransfer && e.dataTransfer.files;
      if(files && files.length){ setFile(files[0]); }
    });
  }
  bindDropzone('dropA','fileA','nameA');
  bindDropzone('dropB','fileB','nameB');
  </script>
    
<script src="lib/xlsx.full.min.js"></script>

    <script>
      (function(){
        function markReady(wb, filename){
          try{
            window.__RESULT_WB__ = wb;                 // 미리보기/다운로드용 워크북
            window.__RESULT_FILENAME__ = filename || 'result.xlsx';
            window.dispatchEvent(new CustomEvent('result-wb-updated', { detail: { filename } }));
          }catch(e){}
        }
        function patchOnce(){
          if (!window.XLSX || window.__WB_PATCHED__) return !!window.__WB_PATCHED__;
          window.__WB_PATCHED__ = true;
          const _writeFile = XLSX.writeFile;
          const _write = XLSX.write;
    
          // ✅ 원본 writeFile을 보관 (수동 다운로드 때 사용)
          window.__XLSX_WRITEFILE_ORIG__ = _writeFile;
    
          if (typeof _writeFile === 'function'){
            XLSX.writeFile = function(wb, filename, opts){
              try { markReady(wb, filename); } catch(e){}
              // ⛔ 자동 다운로드 억제: 원본 호출 막기
              // return _writeFile.call(this, wb, filename, opts);
            };
          }
          if (typeof _write === 'function'){
            XLSX.write = function(wb, opts){
              try { markReady(wb, (opts && opts.bookSST ? 'result.xlsx' : '')); } catch(e){}
              return _write.call(this, wb, opts);
            };
          }
        }
        const tryPatch = () => { patchOnce(); };
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', tryPatch);
        } else { tryPatch(); }
      })();
    </script>
  
    
  <script src="nb2.js"></script>

  <div id="xlPreviewModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-label="엑셀 미리보기">
      <div class="modal-header">
        <strong>엑셀 미리보기</strong>
        <button id="xlPreviewClose" class="btn small" type="button">닫기</button>
      </div>
      <div id="xlSheetTabs" class="tabs"></div>
      <div id="xlPreviewBody" class="table-wrap"></div>
      <div class="modal-footer">
        <span class="muted">* 최대 200행/50열까지만 미리보기로 표시합니다.</span>
      </div>
    </div>
  </div>
    

  <script>
  // ===== Excel Preview (max 200 rows x 50 cols) =====
  (function(){
    function openModal(){ document.getElementById('xlPreviewModal').classList.remove('hidden'); }
    function closeModal(){ document.getElementById('xlPreviewModal').classList.add('hidden'); }
    function setTabs(names, onClick){
      const tabs = document.getElementById('xlSheetTabs');
      tabs.innerHTML = '';
      names.forEach((nm, idx) => {
        const b = document.createElement('button');
        b.className = 'tab' + (idx===0?' active':'');
        b.textContent = nm;
        b.addEventListener('click', () => {
          for(const t of tabs.children){ t.classList.remove('active'); }
          b.classList.add('active'); onClick(idx);
        });
        tabs.appendChild(b);
      });
    }
    function renderTable(data){
      const maxR = 200, maxC = 50;
      const rows = data.slice(0, maxR);
      const cols = Math.min(Math.max(...rows.map(r => r.length), 0), maxC);
      let html = '<table><thead><tr>';
      const header = rows[0] || [];
      for(let c=0;c<cols;c++){ html += '<th>' + (header[c]??'') + '</th>'; }
      html += '</tr></thead><tbody>';
      for(let r=1;r<rows.length;r++){
        html += '<tr>';
        for(let c=0;c<cols;c++){ html += '<td>' + (rows[r]?.[c]??'') + '</td>'; }
        html += '</tr>';
      }
      html += '</tbody></table>';
      return html;
    }
    async function fileToWorkbook(file){
      const buf = await file.arrayBuffer();
      return XLSX.read(buf, { type: 'array' });
    }
    async function previewFromInput(inputId){
      const input = document.getElementById(inputId);
      if(!input || !input.files || !input.files[0]){ alert('먼저 파일을 선택하거나 드래그해 주세요.'); return; }
      const wb = await fileToWorkbook(input.files[0]);
      const sheetNames = wb.SheetNames;
      setTabs(sheetNames, (idx) => {
        const sh = wb.Sheets[sheetNames[idx]];
        const aoa = XLSX.utils.sheet_to_json(sh, { header: 1, raw: true });
        document.getElementById('xlPreviewBody').innerHTML = renderTable(aoa);
      });
      // initial render
      const sh0 = wb.Sheets[sheetNames[0]];
      const aoa0 = XLSX.utils.sheet_to_json(sh0, { header: 1, raw: true });
      document.getElementById('xlPreviewBody').innerHTML = renderTable(aoa0);
      openModal();
    }
    function bindButtons(){
      const closeBtn = document.getElementById('xlPreviewClose');
      if(closeBtn){ closeBtn.addEventListener('click', closeModal); }
      const modal = document.getElementById('xlPreviewModal');
      if(modal){ modal.addEventListener('click', (e)=>{ if(e.target === modal || e.target.classList.contains('modal-backdrop')) closeModal(); }); }
      // page-specific bindings
      const btnA = document.getElementById('previewA');
      if(btnA){ btnA.addEventListener('click', ()=> previewFromInput('fileA')); }
      const btnB = document.getElementById('previewB');
      if(btnB){ btnB.addEventListener('click', ()=> previewFromInput('fileB')); }
      const btnMf = document.getElementById('mfPreview');
      if(btnMf){ btnMf.addEventListener('click', ()=> previewFromInput('mfFile')); }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bindButtons);
    } else { bindButtons(); }
  })();
  </script>
    

    <script>
    (function(){
      function ensureHelpers(){
        if (!window.__renderTable){
          window.__renderTable = function(data){
            const maxR = 200, maxC = 50;
            const rows = data.slice(0, maxR);
            const cols = Math.min(Math.max(...rows.map(r => r.length), 0), maxC);
            let html = '<table><thead><tr>';
            const header = rows[0] || [];
            for(let c=0;c<cols;c++){ html += '<th>' + (header[c]??'') + '</th>'; }
            html += '</tr></thead><tbody>';
            for(let r=1;r<rows.length;r++){
              html += '<tr>';
              for(let c=0;c<cols;c++){ html += '<td>' + (rows[r]?.[c]??'') + '</td>'; }
              html += '</tr>';
            }
            html += '</tbody></table>';
            return html;
          };
        }
        if (!window.__setTabs){
          window.__setTabs = function(names, onClick){
            const tabs = document.getElementById('xlSheetTabs');
            if(!tabs) return;
            tabs.innerHTML = '';
            names.forEach((nm, idx) => {
              const b = document.createElement('button');
              b.className = 'tab' + (idx===0?' active':'');
              b.textContent = nm;
              b.addEventListener('click', () => {
                for(const t of tabs.children){ t.classList.remove('active'); }
                b.classList.add('active'); onClick(idx);
              });
              tabs.appendChild(b);
            });
          };
        }
      }
      function openModal(){ const m = document.getElementById('xlPreviewModal'); if(m) m.classList.remove('hidden'); }
      function closeModal(){ const m = document.getElementById('xlPreviewModal'); if(m) m.classList.add('hidden'); }

      function previewFromWorkbook(wb){
        if(!wb){ alert('결과 워크북이 아직 생성되지 않았습니다. 먼저 실행하세요.'); return; }
        ensureHelpers();
        const names = wb.SheetNames || [];
        if(!names.length){ alert('결과 시트가 없습니다.'); return; }
        __setTabs(names, (idx)=>{
          const sh = wb.Sheets[names[idx]];
          const aoa = XLSX.utils.sheet_to_json(sh, { header: 1, raw: true });
          document.getElementById('xlPreviewBody').innerHTML = __renderTable(aoa);
        });
  

        const sh0 = wb.Sheets[names[0]];
        const aoa0 = XLSX.utils.sheet_to_json(sh0, { header: 1, raw: true });

        // ✅ 종합유사도 기준 내림차순 정렬 추가
        if (aoa0 && aoa0.length > 1) {
          const header = aoa0[0];
          const idx = header.indexOf('종합유사도');
          if (idx >= 0) {
            aoa0.splice(1, aoa0.length - 1,
              ...aoa0.slice(1).sort((a, b) => parseFloat(b[idx]) - parseFloat(a[idx]))
            );
          }
        }

        document.getElementById('xlPreviewBody').innerHTML = __renderTable(aoa0);
        openModal();

      }

      function bindResultButton(){
        const btn = document.getElementById('resultPreview');
        if(!btn) return;
        // Enable button when result workbook is set
        if (window.__RESULT_WB__) btn.disabled = false;
        window.addEventListener('result-wb-updated', ()=>{ btn.disabled = false; });

        btn.addEventListener('click', ()=>{
          previewFromWorkbook(window.__RESULT_WB__);
        });

        // Close handlers if not already wired
        const closeBtn = document.getElementById('xlPreviewClose');
        if(closeBtn && !closeBtn.__bound){
          closeBtn.addEventListener('click', ()=>{
            closeModal();
          });
          closeBtn.__bound = true;
        }
        const modal = document.getElementById('xlPreviewModal');
        if(modal && !modal.__bound){
          modal.addEventListener('click', (e)=>{
            if(e.target === modal || e.target.classList.contains('modal-backdrop')) closeModal();
          });
          modal.__bound = true;
        }
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', bindResultButton);
      } else { bindResultButton(); }
    })();
    </script>
    <script>
    (function(){
      function bindDownloadButton(){
        const btn = document.getElementById('resultDownload');
        if(!btn) return;

        // 결과 워크북이 이미 있으면 버튼 활성화
        if (window.__RESULT_WB__) btn.disabled = false;

        // 결과 생성 후 이벤트 수신 시 활성화
        window.addEventListener('result-wb-updated', (e)=>{
          btn.disabled = false;
          if (e?.detail?.filename) window.__RESULT_FILENAME__ = e.detail.filename;
        });

        // 클릭 시 실제 다운로드 실행
        btn.addEventListener('click', ()=>{
          const wb = window.__RESULT_WB__;
          if(!wb){
            alert('결과가 아직 생성되지 않았습니다. 먼저 실행하세요.');
            return;
          }
          const fname = window.__RESULT_FILENAME__ || 'result.xlsx';
          const orig = window.__XLSX_WRITEFILE_ORIG__ || (window.XLSX && XLSX.writeFile);
          if(typeof orig !== 'function'){
            alert('다운로드 함수를 찾지 못했습니다.');
            return;
          }
          orig.call(XLSX, wb, fname);
        });
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', bindDownloadButton);
      } else {
        bindDownloadButton();
      }
    })();
    </script>

    
</body>
</html>

